<!DOCTYPE html>
<html>
<head>
  <title>LM Astro Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./style.css">

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="./running.js"></script>
</head>

<body>

<h2>LM Astro Engine ğŸš€</h2>

<button id="openToolsBtn">âš™ï¸ Open Tools</button>

<pre id="resultBox">ğŸ”„ Booting Astro Engine...</pre>

<!-- ===================================================
ğŸ§° TOOL PANEL (POPUP)
=================================================== -->
<div id="toolPanel" class="panelHidden">

  <h3>Choose Tool</h3>

  <button id="chartBtn">ğŸª Generate Birth Chart</button>

  <hr>

  <input type="file" id="chartImageInput" accept="image/*">
  <button id="extractBtn">ğŸ“¸ Extract Chart Data</button>

  <br><br>
  <button id="closePanel">Close</button>

</div>

<script type="module">
console.log("UI READY");

const box = document.getElementById("resultBox");

/* ================= PANEL CONTROL ================= */

const panel = document.getElementById("toolPanel");

document.getElementById("openToolsBtn").onclick = () =>{
  panel.classList.remove("panelHidden");
}

document.getElementById("closePanel").onclick = () =>{
  panel.classList.add("panelHidden");
}

/* ================= SWISS WORKER ================= */

const worker = new Worker("./swissworker.js",{ type:"module" });

worker.onmessage = (e)=>{
  if(e.data.type==="ready") box.textContent="âœ… Swiss Ready";
  if(e.data.type==="result") box.textContent=JSON.stringify(e.data.data,null,2);
  if(e.data.type==="error") box.textContent="âŒ "+e.data.message;
  if(e.data.type==="log") box.textContent += "\n"+e.data.message;
};

worker.postMessage({ type:"init" });

/* ================= GENERATE CHART ================= */

document.getElementById("chartBtn").onclick = () =>{

  const dob = prompt("Enter DOB (YYYY-MM-DD)");
  const tob = prompt("Enter TOB (HH:MM)");

  if(!dob || !tob) return;

  box.textContent="ğŸ”® Calculating...";
  worker.postMessage({ type:"calc", dob, tob });
};

/* ================= OCR EXTRACTOR ================= */

document.getElementById("extractBtn").onclick = async ()=>{

  const file = document.getElementById("chartImageInput").files[0];

  if(!file){
    alert("Upload chart image first");
    return;
  }

  box.textContent="ğŸ“¸ Reading chart...";
  const result = await window.extractChartFromImage(file);

  box.textContent = JSON.stringify(result,null,2);
};

</script>

</body>
</html>
